"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.throwError = exports.getInputs = exports.getActions = exports.getCurrentPath = exports.getProjectConfig = exports.humanWarning = void 0;
var lodash_1 = require("lodash");
var path_1 = __importDefault(require("path"));
var libs_1 = require("../../libs");
var logger_1 = require("../../logger");
var chalk_1 = __importDefault(require("chalk"));
function humanWarning(tips) {
    logger_1.logger.log("\n" + chalk_1.default.hex('#000').bgYellow('WARNING:') + "\n======================\n" + libs_1.makeUnderLine(tips) + "\n", 'yellow');
}
exports.humanWarning = humanWarning;
function getProjectConfig(configs, serviceName, globalArgs) {
    var services = lodash_1.get(configs, 'services', {});
    var data = lodash_1.get(services, serviceName, {});
    var provider = data.provider || configs.provider;
    var access = data.access || configs.access;
    return lodash_1.assign({}, data, {
        access: (globalArgs === null || globalArgs === void 0 ? void 0 : globalArgs.access) || access,
        provider: provider,
        appName: configs.name,
        serviceName: serviceName,
    });
}
exports.getProjectConfig = getProjectConfig;
function getCurrentPath(p, spath) {
    if (p === void 0) { p = './'; }
    if (path_1.default.isAbsolute(p))
        return p;
    var dir = path_1.default.dirname(spath);
    return p ? path_1.default.join(dir, p) : dir;
}
exports.getCurrentPath = getCurrentPath;
function getActions(configs, _a) {
    var method = _a.method, spath = _a.spath;
    function validate(hook) {
        if ('run' in hook && !('component' in hook) && !('plugin' in hook))
            return 'run';
        if ('component' in hook && !('run' in hook) && !('plugin' in hook))
            return 'component';
        if ('plugin' in hook && !('run' in hook) && !('component' in hook))
            return 'plugin';
        throw new Error(JSON.stringify({
            message: 'actions configuration is incorrect.',
            tips: 'Please check the configuration of actions.',
        }));
    }
    var actions = configs.actions;
    if (lodash_1.isEmpty(actions))
        return;
    var hooks = [];
    var keyList = lodash_1.keys(actions);
    for (var _i = 0, keyList_1 = keyList; _i < keyList_1.length; _i++) {
        var actionKey = keyList_1[_i];
        var hookList = actions[actionKey];
        var _b = lodash_1.split(actionKey, '-'), start = _b[0], end = _b[1];
        if (end === method) {
            for (var _c = 0, hookList_1 = hookList; _c < hookList_1.length; _c++) {
                var hookDetail = hookList_1[_c];
                var type = validate(hookDetail);
                if (type === 'run') {
                    var obj = {
                        type: type,
                        value: hookDetail[type],
                        path: getCurrentPath(hookDetail.path, spath),
                        pre: start === 'pre' ? true : false,
                    };
                    hooks.push(obj);
                }
                if (type === 'component') {
                    var obj = {
                        type: type,
                        value: hookDetail[type],
                        pre: start === 'pre' ? true : false,
                    };
                    hooks.push(obj);
                }
                if (type === 'plugin') {
                    var obj = {
                        type: type,
                        value: hookDetail[type],
                        pre: start === 'pre' ? true : false,
                        args: hookDetail.args,
                    };
                    hooks.push(obj);
                }
            }
        }
    }
    return hooks;
}
exports.getActions = getActions;
function getInputs(configs, _a) {
    var method = _a.method, args = _a.args, spath = _a.spath, serverName = _a.serverName, output = _a.output;
    var argsObj = lodash_1.filter(args, function (o) { return !lodash_1.includes([serverName, method], o); });
    var inputs = {
        props: configs.props,
        credentials: configs.credentials,
        appName: configs.appName,
        project: {
            component: configs.component,
            access: configs.access,
            projectName: configs.serviceName,
            provider: configs.provider,
        },
        command: method,
        args: lodash_1.join(argsObj, ' '),
        argsObj: argsObj,
        path: {
            configPath: spath,
        },
        output: output,
    };
    return inputs;
}
exports.getInputs = getInputs;
function throwError(params) {
    var error = params.error, serviceName = params.serviceName;
    var jsonMsg;
    try {
        jsonMsg = JSON.parse(error.message);
    }
    catch (error) { }
    if (jsonMsg && jsonMsg.tips) {
        throw new Error(JSON.stringify({
            code: 101,
            message: jsonMsg.message,
            tips: jsonMsg.tips,
            prefix: "Project " + serviceName + " failed to execute:",
        }));
    }
    else {
        throw new Error(JSON.stringify({
            code: 101,
            message: error.message,
            stack: error.stack,
            prefix: "Project " + serviceName + " failed to execute:",
        }));
    }
}
exports.throwError = throwError;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tbW9uL2V4ZWNDb21tYW5kL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGlDQUFtRjtBQUNuRiw4Q0FBd0I7QUFFeEIsbUNBQTJDO0FBQzNDLHVDQUFzQztBQUN0QyxnREFBMEI7QUFFMUIsU0FBZ0IsWUFBWSxDQUFDLElBQVk7SUFDdkMsZUFBTSxDQUFDLEdBQUcsQ0FDUixPQUFLLGVBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxrQ0FBNkIsb0JBQWEsQ0FBQyxJQUFJLENBQUMsT0FBSSxFQUMvRixRQUFRLENBQ1QsQ0FBQztBQUNKLENBQUM7QUFMRCxvQ0FLQztBQUVELFNBQWdCLGdCQUFnQixDQUM5QixPQUFZLEVBQ1osV0FBbUIsRUFDbkIsVUFBdUI7SUFFdkIsSUFBTSxRQUFRLEdBQUcsWUFBRyxDQUFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDOUMsSUFBTSxJQUFJLEdBQUcsWUFBRyxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDNUMsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDO0lBQ25ELElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUM3QyxPQUFPLGVBQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFO1FBQ3RCLE1BQU0sRUFBRSxDQUFBLFVBQVUsYUFBVixVQUFVLHVCQUFWLFVBQVUsQ0FBRSxNQUFNLEtBQUksTUFBTTtRQUNwQyxRQUFRLFVBQUE7UUFDUixPQUFPLEVBQUUsT0FBTyxDQUFDLElBQUk7UUFDckIsV0FBVyxhQUFBO0tBQ1osQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQWZELDRDQWVDO0FBRUQs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
"use strict";
/**
 * @description 用于存放工具函数
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAvailablePort = exports.sleep = exports.writeJsonFile = exports.readJsonFile = exports.getGlobalArgs = exports.getServerlessDevsTempArgv = exports.makeUnderLine = void 0;
var fs = __importStar(require("fs-extra"));
var lodash_1 = require("lodash");
var minimist_1 = __importDefault(require("minimist"));
var chalk_1 = __importDefault(require("chalk"));
var net_1 = __importDefault(require("net"));
var makeUnderLine = function (text) {
    var matchs = text.match(/http[s]?:\/\/[^\s|,]+/);
    if (matchs) {
        return text.replace(matchs[0], chalk_1.default.underline(matchs[0]));
    }
    else {
        return text;
    }
};
exports.makeUnderLine = makeUnderLine;
function getServerlessDevsTempArgv() {
    var serverless_devs_temp_argv = process.env.serverless_devs_temp_argv;
    if (lodash_1.isEmpty(serverless_devs_temp_argv)) {
        return {};
    }
    try {
        var tempArgv = JSON.parse(serverless_devs_temp_argv);
        return getGlobalArgs(tempArgv);
    }
    catch (error) {
        return {};
    }
}
exports.getServerlessDevsTempArgv = getServerlessDevsTempArgv;
function getGlobalArgs(args) {
    if (lodash_1.isEmpty(args))
        return { _: [] };
    var newArgs = [];
    var _argsObj = [];
    var lastVal;
    var nextRemove;
    for (var index in args) {
        var val = lodash_1.trim(args[index]);
        // 将参数放到_argsObj, - 或者 -- 开头
        if (lodash_1.startsWith(val, '-') || _argsObj.length > 0) {
            _argsObj.push(val);
        }
        if (nextRemove) {
            nextRemove = false;
            continue;
        }
        if (/\s/.test(val) && lodash_1.startsWith(lastVal, '-')) {
            // 对包含空格的参数 单独处理
            newArgs.pop();
        }
        else if (lodash_1.startsWith(val, '-') && !lodash_1.startsWith(val, '--') && val.length > 2) {
            // 对类似 -la 的参数 单独处理
            nextRemove = true;
        }
        else {
            newArgs.push(val);
        }
        lastVal = val;
    }
    var data = minimist_1.default(newArgs, {
        alias: {
            template: 't',
            access: 'a',
            help: 'h',
            version: 'v',
        },
        string: ['access', 'template', 'env'],
        boolean: ['debug', 'skip-actions', 'help', 'version'],
    });
    return lodash_1.assign({ _argsObj: _argsObj }, data);
}
exports.getGlobalArgs = getGlobalArgs;
function readJsonFile(filePath) {
    if (fs.existsSync(filePath)) {
        var data = fs.readFileSync(filePath, 'utf8');
        try {
            return JSON.parse(data);
        }
        catch (error) { }
    }
}
exports.readJsonFile = readJsonFile;
function writeJsonFile(filePath, data) {
    fs.writeFileSync(filePath, JSON.stringify(data, null, 2), 'utf-8');
}
exports.writeJsonFile = writeJsonFile;
function sleep(timer) {
    return new Promise(function (resolve) {
        setTimeout(function () { return resolve(true); }, timer);
    });
}
exports.sleep = sleep;
function getAvailablePort(port) {
    if (port === void 0) { port = 3000; }
    var server = net_1.default.createServer().listen(port);
    return new Promise(function (resolve, reject) {
        server.on('listening', function () {
            server.close();
            resolve(port);
        });
        server.on('error', function (err) {
            if (err.code === 'EADDRINUSE') {
                resolve(getAvailablePort(port + 1));
            }
            else {
                reject(err);
            }
        });
    });
}
exports.getAvailablePort = getAvailablePort;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGlicy91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSCwyQ0FBK0I7QUFFL0IsaUNBQTJEO0FBQzNELHNEQUFnQztBQUNoQyxnREFBMEI7QUFDMUIsNENBQXNCO0FBRWYsSUFBTSxhQUFhLEdBQUcsVUFBQyxJQUFZO0lBQ3hDLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQztJQUNuRCxJQUFJLE1BQU0sRUFBRTtRQUNWLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsZUFBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzVEO1NBQU07UUFDTCxPQUFPLElBQUksQ0FBQztLQUNiO0FBQ0gsQ0FBQyxDQUFDO0FBUFcsUUFBQSxhQUFhLGlCQU94QjtBQUVGLFNBQWdCLHlCQUF5QjtJQUMvQixJQUFBLHlCQUF5QixHQUFLLE9BQU8sQ0FBQyxHQUFHLDBCQUFoQixDQUFpQjtJQUNsRCxJQUFJLGdCQUFPLENBQUMseUJBQXlCLENBQUMsRUFBRTtRQUN0QyxPQUFPLEVBQUUsQ0FBQztLQUNYO0lBQ0QsSUFBSTtRQUNGLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUN2RCxPQUFPLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNoQztJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ2QsT0FBTyxFQUFFLENBQUM7S0FDWDtBQUNILENBQUM7QUFYRCw4REFXQztBQUVELFNBQWdCLGFBQWEsQ0FBQyxJQUFjO0lBQzFDLElBQUksZ0JBQU8sQ0FBQyxJQUFJLENBQUM7UUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFB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